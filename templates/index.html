<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>QR Code Verification</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <style>
        #reader {
            width: 100%;
            max-width: 640px;
            height: auto;
            margin: auto;
        }
        #reader video {
            width: 100% !important;
            height: auto !important;
        }
    </style>
</head>
<body>
    <h1>Scan QR Code to Start Face Recognition</h1>
    <div id="reader"></div>
    <button id="flip-camera">Flip Camera</button>
    <p id="message"></p>
    <form id="code-form" method="post" action="/" style="display:none;">
        <input type="hidden" id="code" name="code">
    </form>

    <script>
        let cameraId = 0;
        let cameras = [];
        let currentCameraIndex = 0;
        const cameraConfig = { fps: 10, qrbox: 250 };
        const codeReader = new Html5Qrcode("reader");

        function onScanSuccess(decodedText, decodedResult) {
            document.getElementById('code').value = decodedText;
            document.getElementById('code-form').submit();
        }

        function requestCameraAccess() {
            Html5Qrcode.getCameras().then(camerasList => {
                if (camerasList && camerasList.length) {
                    cameras = camerasList;
                    cameraId = cameras[currentCameraIndex].id;
                    startScanning(cameraId);
                } else {
                    document.getElementById('message').innerText = 'No cameras found.';
                }
            }).catch(err => {
                console.error(err);
                document.getElementById('message').innerText = 'Error accessing camera: ' + err;
            });
        }

        function startScanning(cameraId) {
            codeReader.start(
                { deviceId: { exact: cameraId } },
                cameraConfig,
                onScanSuccess
            ).catch(err => {
                console.error(err);
                document.getElementById('message').innerText = 'Unable to start scanning: ' + err;
            });
        }

        document.getElementById('flip-camera').addEventListener('click', function() {
            if (cameras.length > 1) {
                currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
                cameraId = cameras[currentCameraIndex].id;
                codeReader.stop().then(() => {
                    startScanning(cameraId);
                }).catch(err => {
                    console.error('Failed to stop the camera:', err);
                });
            }
        });

        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    requestCameraAccess();
                })
                .catch(err => {
                    console.error('Camera permission denied:', err);
                    document.getElementById('message').innerText = 'Camera permission denied: ' + err;
                });
        } else {
            document.getElementById('message').innerText = 'Camera not supported by this browser.';
        }
    </script>
</body>
</html>
